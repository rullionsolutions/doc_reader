<!DOCTYPE html>
<html lang="en">
	<head>
		<title></title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="author" content="Stephen Francis">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<link rel="stylesheet" type="text/css" href="/cdn/twitter-bootstrap-v2.3.2/css/bootstrap.min.css" media="screen" />
		<link rel="stylesheet" type="text/css" href="/cdn/twitter-bootstrap-v2.3.2/css/bootstrap-responsive.min.css" />
		<style>
			body { font-size: 12pt; }

			/* Viz Styling... */
			.node			{ font-family: Arial; }
			#left_pane 		{ overflow-wrap: break-word; }
			code 			{ display: block; white-space: pre-wrap; }
		</style>
	</head>

	<body>

		<div class="container-fluid">
			<div class="row-fluid">
				<div class="span2" id="left_pane">
					<h3><a id="repo_title" ></a></h3>
					<h4 id="page_title"></h4>
					<br/>
					<br/>
					<h4>All Repos</h4>
					<div id="other_repos">
					</div>
				</div>	<!-- #left_bar .visible-desktop -->

				<div class="span8" id="right_pane">
					Loading...
				</div>	<!-- .span10 -->

			</div>	<!-- .row-fluid -->
		</div>	<!-- .container-fluid -->

		<script type="text/javascript" src="/cdn/jquery-v1.11.3/jquery-1.11.3.min.js"> </script>
		<script type="text/javascript" src="showdown.js"> </script>
		<script type="text/javascript" src="viz.js"> </script>
		<script type="text/javascript">

			var repo = queryParams().repo || "rsl-app-docs",
				page = queryParams().page || "README.md",
				path = page.substr(0, page.lastIndexOf("/") + 1),
				converter;

			function splitParams(str) {
			    var e,
			        a = /\+/g,  // Regex for replacing addition symbol with a space
			        r = /([^&=]+)=?([^&]*)/g,
			        d = function (s) { return decodeURIComponent(s.replace(a, " ")); },
			        q = str,
			        out = {};
			    e = r.exec(q);
			    while (e) {
			        out[d(e[1])] = d(e[2]);
			        e = r.exec(q);
			    }
			    return out;
			}

			function queryParams() {
			    return splitParams(location.search.substring(1));
			}

			function convertAndDisplay(selector, data_back) {
    			document.title = page;
				$(selector).html(converter.makeHtml(data_back));
				$(selector).find("a[href]").each(function () {
					var new_page = $(this).attr("href");
					$(this).attr("href", "?repo=" + repo + "&page=" + path + new_page);
				});
				$(selector).find("img[src]").each(function () {
					var src = $(this).attr("src");
					if (src.indexOf(":") === -1 && src.indexOf("/") !== 0) {	// protocol not specified, relative URL
						$(this).attr("src", "../" + repo + "/" + path + src);
					}
				});
				$(selector).find("p").each(function () {
					if ($(this).text().indexOf("digraph") === 0) {
						applyViz(this);
					}
				})
			}

			function discoverRepos() {
				var possible_repos = [
						"rsl-app-docs",
						"rsl-other-docs"
					];

				while (possible_repos.length > 0) {
					checkRepo(possible_repos.shift())
				}
			}

			function checkRepo(repo) {
				console.log("Checking: " + repo);
				$.ajax({ url: "../" + repo + "/README.md", type: "GET",
					success: function (data_back) {
						$("#other_repos").append("<p><a href='?repo=" + repo + "'>" + repo + "</a></p>");
					}
				});
			}

			function applyViz(elmt) {
				var text = $(elmt).text().replace("{", "{" +
				    " graph [ penwidth=1, bgcolor=transparent ]; " +
    				" node  [ fontname=Arial, fontsize=10, shape=box ]; " +
    				" edge  [ fontname=Arial, fontsize=10 ]; ");

				$(elmt).html(Viz(text, "svg"));
			}

			$(document).ready(function() {
				converter = new Showdown.converter();
				discoverRepos();

				if (repo && page) {
					$("#repo_title").attr("href", "?repo=" + repo);
					$("#repo_title").text(repo);
					$("#page_title").text(page);
					$(document).attr("title", repo + "/" + page);
					$.ajax({ url: "../" + repo + "/" + page, type: "GET",
						success: function (data_back) {
							convertAndDisplay("#right_pane", data_back);
						},
						error: function () {
							$("#right_pane").html("not found :-(");
						}
					});
				} else {
					alert("URL parameters 'repo' and 'page' expected!");
				}
			});
		</script>
	</body>
</html>
